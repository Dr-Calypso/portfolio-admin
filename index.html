<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio Gallery</title>
  <meta name="description" content="Gallery of medical student portfolios" />
  <link rel="stylesheet" href="gallery.css?v=20250928.1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}</style>
</head>
<body>
  <script>
    /*
      VC / Admin Mode Bootstrap
      ---------------------------------
      portfolio.html (after Google sign-in) will set localStorage.vcMode="1" when
      the authenticated email matches the configured VC email. Normal students will
      have this cleared.

      When vcMode is active we fetch the manifest (files list) from a secure
      backend / Apps Script Web App instead of the local static files.json. The
      backend is expected to expose:
        GET <WEB_APP_URL>/manifest   -> returns JSON array like [{file:"ROLL001.enc.json", roll:"ROLL001", updatedAt:"..."}, ...]
        GET <WEB_APP_URL>/portfolio?file=ROLL001.enc.json -> returns decrypted (or plaintext) portfolio JSON

      Replace the placeholder value below with your deployed Apps Script Web App URL.
    */
    (function(){
      const VC_WEB_APP_URL = window.VC_WEB_APP_URL || 'YOUR_APPS_SCRIPT_WEB_APP_URL'; // <-- TODO: set real URL
      const isVc = localStorage.getItem('vcMode') === '1';
      if(isVc){
        window.__VC_MODE = true;
        const base = VC_WEB_APP_URL.replace(/\/$/,'');
        // Retrieve stored ID token (if previously signed in on portfolio.html)
        let idTok = null; try { idTok = localStorage.getItem('vcIdToken'); } catch(_){ }
        if(idTok){
          window.__VC_ID_TOKEN = idTok;
          window.__REMOTE_MANIFEST_URL = base + '/manifest?idToken=' + encodeURIComponent(idTok);
          window.__REMOTE_PORTFOLIO_BASE = base + '/portfolio?file='; // append idToken per request in gallery.js
        } else {
          window.__REMOTE_MANIFEST_URL = base + '/manifest';
          window.__REMOTE_PORTFOLIO_BASE = base + '/portfolio?file=';
        }
        console.log('[vc-mode] Enabled. Remote manifest:', window.__REMOTE_MANIFEST_URL);
      } else {
        window.__VC_MODE = false;
        // Offline / non-VC fallback: allow using local files.json gallery if it exists.
        // Strategy: attempt a fast HEAD/GET fetch for files.json with a short timeout.
        const allowParam = location.search.includes('allowGallery=1');
        if(!allowParam){
          const controller = new AbortController();
          const t = setTimeout(()=>controller.abort(), 1200); // 1.2s quick probe
          fetch('files.json', { method:'GET', cache:'no-store', signal:controller.signal })
            .then(r=>{ clearTimeout(t); if(r.ok){ console.log('[gallery] Local files.json detected â€“ allowing offline gallery.'); } else { throw new Error('status '+r.status); } })
            .catch(()=>{
              try { window.location.replace('portfolio.html'); } catch(_) {}
            });
        }
      }
    })();
  </script>
  <header class="gal-header">
    <div class="gal-container gal-header-inner">
      <div class="rmu-brand">
        <img src="RMUlogo.png" alt="Rawalpindi Medical University Logo" loading="lazy" />
        <div class="rmu-text">
          <div class="rmu-university">RAWALPINDI MEDICAL UNIVERSITY</div>
          <div class="rmu-sub">PORTFOLIO GALLERY</div>
        </div>
      </div>
      <h1 class="gal-title">Portfolio Gallery <small>Academic Archive</small></h1>
      <div class="gal-search-wrapper">
        <input id="search-box" type="search" placeholder="Search by name..." aria-label="Search portfolios" autocomplete="off" />
        <label style="display:inline-flex;align-items:center;gap:6px;margin-left:12px;font-size:12px;color:var(--gal-accent-alt);cursor:pointer;">
          <input type="checkbox" id="scan-toggle" checked style="accent-color:var(--gal-accent);"> Auto Scan
        </label>
      </div>
    </div>
  </header>

  <main class="gal-main gal-container">
    <div id="status-bar" class="gal-status" role="status" aria-live="polite">Loading portfolios...</div>
    <div id="scan-progress" style="height:6px;border-radius:4px;background:#d4dde7;overflow:hidden;position:relative;display:none;margin:-4px 0 14px;">
      <div id="scan-progress-bar" style="height:100%;width:0;background:linear-gradient(90deg,#0a66c2,#2b79ff);transition:width .35s ease;filter:saturate(1.2);"></div>
    </div>
    <div id="gallery-grid" class="gal-grid" aria-label="Portfolio list" role="list"></div>
  </main>

  <footer class="gal-footer">
    <div class="gal-container">
      <small>&copy; <span id="year"></span> RMU Portfolio Gallery. <span id="count"></span></small>
    </div>
  </footer>

  <script src="gallery.js?v=20250928.1"></script>
  <script>document.getElementById('year').textContent=new Date().getFullYear();</script>
</body>
</html>
